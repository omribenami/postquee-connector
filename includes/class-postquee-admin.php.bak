<?php
/**
 * Admin functionality class
 *
 * @package PostQuee
 */

if (!defined('ABSPATH')) {
	exit;
}

class PostQuee_Admin
{
	private $plugin_name;
	private $version;
	private $api_url_default = 'https://api.postiz.com'; // Default per instructions

	public function __construct($plugin_name, $version)
	{
		$this->plugin_name = $plugin_name;
		$this->version = $version;
	}

	/**
	 * Main entry point for registering hooks
	 */
	public function init_hooks()
	{
		// menus
		add_action('admin_menu', array($this, 'add_plugin_admin_menu'));
		add_action('admin_bar_menu', array($this, 'add_admin_bar_menu'), 999);

		// settings
		add_action('admin_init', array($this, 'register_settings'));
		add_action('admin_init', array($this, 'add_privacy_policy_content'));

		// assets
		add_action('admin_enqueue_scripts', array($this, 'enqueue_styles'));
		add_action('admin_enqueue_scripts', array($this, 'enqueue_scripts'));
		add_action('wp_enqueue_scripts', array($this, 'enqueue_scripts')); // Frontend for admin bar

		// Post handling
		add_action('add_meta_boxes', array($this, 'add_meta_box'));
		add_action('save_post', array($this, 'handle_save_post'));

		// AJAX
		add_action('wp_ajax_postquee_delete_post', array($this, 'ajax_delete_post'));
		add_action('wp_ajax_postquee_send_post', array($this, 'ajax_send_post_manual'));
	}

	public function add_plugin_admin_menu()
	{
		add_menu_page(
			'PostQuee Hub',
			'PostQuee Hub',
			'manage_options',
			'postquee',
			array($this, 'display_plugin_admin_page'),
			'dashicons-share',
			25
		);
	}

	public function register_settings()
	{
		register_setting('postquee_options', 'postquee_api_key');
		register_setting('postquee_options', 'postquee_base_url', array('default' => $this->api_url_default));
	}

	public function enqueue_styles($hook)
	{
		// Enqueue on all admin pages or restrict? Keeping broad for now as per previous logic
		wp_enqueue_style($this->plugin_name, POSTQUEE_BRIDGE_URL . 'assets/css/postquee-bridge.css', array(), $this->version, 'all');
	}

	public function enqueue_scripts($hook)
	{
		// Basic hook check to avoid loading globally on backend if not needed, 
		// but we need it on edit screens and our page.
		wp_enqueue_script($this->plugin_name, POSTQUEE_BRIDGE_URL . 'assets/js/postquee-bridge.js', array('jquery'), $this->version, true);

		wp_localize_script(
			$this->plugin_name,
			'postqueeObj',
			array(
				'ajaxUrl' => admin_url('admin-ajax.php'),
				'nonce' => wp_create_nonce('postquee_nonce'),
			)
		);
	}

	// --------------------------------------------------------------------------
	// API Helper
	// --------------------------------------------------------------------------
	private function request($endpoint, $method = 'GET', $body = null)
	{
		$api_key = get_option('postquee_api_key');
		$base_url = get_option('postquee_base_url', $this->api_url_default);

		// Ensure no double slashes
		$url = untrailingslashit($base_url) . $endpoint;

		$args = array(
			'method' => $method,
			'headers' => array(
				'Authorization' => 'Bearer ' . $api_key,
				'Content-Type' => 'application/json',
				'Accept' => 'application/json'
			),
			'timeout' => 20
		);

		if ($body && $method !== 'GET') {
			$args['body'] = json_encode($body);
		}

		$response = wp_remote_request($url, $args);

		if (is_wp_error($response)) {
			return $response;
		}

		$code = wp_remote_retrieve_response_code($response);
		$body_content = wp_remote_retrieve_body($response);
		$data = json_decode($body_content, true);

		if ($code >= 300) {
			return new WP_Error('api_error', isset($data['message']) ? $data['message'] : 'API Error ' . $code);
		}

		return $data;
	}

	// --------------------------------------------------------------------------
	// Admin Dashboard (Tabs)
	// --------------------------------------------------------------------------
	public function display_plugin_admin_page()
	{
		if (!current_user_can('manage_options')) {
			wp_die(esc_html__('Permission denied.', 'postquee-connector'));
		}

		$active_tab = isset($_GET['tab']) ? $_GET['tab'] : 'feed';
		?>
		<div class="wrap">
			<h1><?php esc_html_e('PostQuee Hub', 'postquee-connector'); ?></h1>
			<h2 class="nav-tab-wrapper">
				<a href="?page=postquee&tab=feed"
					class="nav-tab <?php echo $active_tab == 'feed' ? 'nav-tab-active' : ''; ?>"><?php esc_html_e('Feed', 'postquee-connector'); ?></a>
				<a href="?page=postquee&tab=channels"
					class="nav-tab <?php echo $active_tab == 'channels' ? 'nav-tab-active' : ''; ?>"><?php esc_html_e('Channels', 'postquee-connector'); ?></a>
				<a href="?page=postquee&tab=settings"
					class="nav-tab <?php echo $active_tab == 'settings' ? 'nav-tab-active' : ''; ?>"><?php esc_html_e('Settings', 'postquee-connector'); ?></a>
			</h2>
			<div class="postquee-tab-content" style="margin-top:20px;">
				<?php
				switch ($active_tab) {
					case 'channels':
						$this->render_channels_tab();
						break;
					case 'settings':
						$this->render_settings_tab();
						break;
					case 'feed':
					default:
						$this->render_feed_tab();
						break;
				}
				?>
			</div>
		</div>
		<?php
	}

	private function render_settings_tab()
	{
		?>
		<form method="post" action="options.php" class="card" style="padding:20px; max-width:600px;">
			<?php
			settings_fields('postquee_options');
			do_settings_sections('postquee_options');
			?>
			<table class="form-table">
				<tr valign="top">
					<th scope="row"><?php esc_html_e('API Key', 'postquee-connector'); ?></th>
					<td>
						<input type="password" name="postquee_api_key"
							value="<?php echo esc_attr(get_option('postquee_api_key')); ?>" class="regular-text"
							style="width:100%;" />
					</td>
				</tr>
				<tr valign="top">
					<th scope="row"><?php esc_html_e('Base URL', 'postquee-connector'); ?></th>
					<td>
						<input type="url" name="postquee_base_url"
							value="<?php echo esc_attr(get_option('postquee_base_url', $this->api_url_default)); ?>"
							class="regular-text" style="width:100%;" />
						<p class="description"><?php esc_html_e('Default: https://api.postiz.com', 'postquee-connector'); ?></p>
					</td>
				</tr>
			</table>
			<?php submit_button(); ?>
		</form>
		<?php
	}

	private function render_feed_tab()
	{
		$posts = $this->request('/posts'); // GET /posts
		if (is_wp_error($posts)) {
			echo '<div class="notice notice-error"><p>' . esc_html($posts->get_error_message()) . '</p></div>';
			return;
		}

		// Structure depends on actual API response. Assuming basic array of objects.
		// If wrapper exists (e.g. data => []), adjust. Assuming direct array or data key.
		$items = isset($posts['data']) ? $posts['data'] : $posts;
		if (!is_array($items)) {
			echo '<p>' . esc_html__('No posts found or invalid response.', 'postquee-connector') . '</p>';
			return;
		}
		?>
		<table class="wp-list-table widefat fixed striped">
			<thead>
				<tr>
					<th><?php esc_html_e('Content', 'postquee-connector'); ?></th>
					<th><?php esc_html_e('Scheduled Date', 'postquee-connector'); ?></th>
					<th><?php esc_html_e('Status', 'postquee-connector'); ?></th>
					<th><?php esc_html_e('Actions', 'postquee-connector'); ?></th>
				</tr>
			</thead>
			<tbody>
				<?php if (empty($items)): ?>
					<tr>
						<td colspan="4"><?php esc_html_e('No posts yet.', 'postquee-connector'); ?></td>
					</tr>
				<?php else: ?>
					<?php foreach ($items as $item):
						$content = isset($item['content']) ? $item['content'] : (isset($item['title']) ? $item['title'] : '-');
						$date = isset($item['scheduledAt']) ? $item['scheduledAt'] : '-';
						$status = isset($item['status']) ? $item['status'] : 'draft';
						$id = isset($item['id']) ? $item['id'] : '';
						?>
						<tr>
							<td><?php echo esc_html(substr($content, 0, 100)) . '...'; ?></td>
							<td><?php echo esc_html($date); ?></td>
							<td><span class="badge"><?php echo esc_html($status); ?></span></td>
							<td>
								<?php if ($id): ?>
									<button class="button button-small postquee-delete-btn" data-id="<?php echo esc_attr($id); ?>"
										style="color:#b32d2e; border-color:#b32d2e;"><?php esc_html_e('Delete', 'postquee-connector'); ?></button>
								<?php endif; ?>
							</td>
						</tr>
					<?php endforeach; ?>
				<?php endif; ?>
			</tbody>
		</table>
		<?php
	}

	private function render_channels_tab()
	{
		$channels = $this->get_channels_cached();
		?>
		<table class="wp-list-table widefat fixed striped" style="max-width:800px;">
			<thead>
				<tr>
					<th><?php esc_html_e('Channel Name', 'postquee-connector'); ?></th>
					<th><?php esc_html_e('Type', 'postquee-connector'); ?></th>
				</tr>
			</thead>
			<tbody>
				<?php if (empty($channels) || is_wp_error($channels)): ?>
					<tr>
						<td colspan="2">
							<?php esc_html_e('No channels connected. Please connect channels in PostQuee.', 'postquee-connector'); ?>
						</td>
					</tr>
				<?php else: ?>
					<?php foreach ($channels as $ch):
						$name = isset($ch['name']) ? $ch['name'] : 'Unknown';
						$type = isset($ch['provider']) ? $ch['provider'] : 'Unknown';
						?>
						<tr>
							<td><strong><?php echo esc_html($name); ?></strong></td>
							<td><?php echo esc_html(ucfirst($type)); ?></td>
						</tr>
					<?php endforeach; ?>
				<?php endif; ?>
			</tbody>
		</table>
		<?php
	}

	// --------------------------------------------------------------------------
	// Meta Box & Post Integration
	// --------------------------------------------------------------------------
	public function add_meta_box()
	{
		add_meta_box('postquee_mb', 'PostQuee', array($this, 'render_meta_box'), 'post', 'side', 'high');
	}

	public function render_meta_box($post)
	{
		// Nonce for verification
		wp_nonce_field('postquee_save_action', 'postquee_meta_nonce');

		$channels = $this->get_channels_cached();
		?>
		<p>
			<label>
				<input type="checkbox" name="postquee_schedule" value="1" />
				<strong><?php esc_html_e('Schedule for PostQuee', 'postquee-connector'); ?></strong>
			</label>
		</p>

		<?php if (!empty($channels) && !is_wp_error($channels)): ?>
			<p><strong><?php esc_html_e('Select Channels:', 'postquee-connector'); ?></strong></p>
			<ul style="margin: 5px 0 15px 10px; max-height: 150px; overflow-y:auto;">
				<?php foreach ($channels as $ch):
					$id = $ch['id'];
					$name = $ch['name'];
					$provider = isset($ch['provider']) ? $ch['provider'] : '';
					?>
					<li>
						<label>
							<input type="checkbox" name="postquee_channels[]" value="<?php echo esc_attr($id); ?>" checked />
							<?php echo esc_html("$name ($provider)"); ?>
						</label>
					</li>
				<?php endforeach; ?>
			</ul>
		<?php else: ?>
			<p class="description"><?php esc_html_e('No channels found. Check settings or API key.', 'postquee-connector'); ?></p>
		<?php endif; ?>

		<hr>
		<p>
			<a
				href="<?php echo esc_url(admin_url('admin.php?page=postquee&tab=settings')); ?>"><?php esc_html_e('Configure Settings', 'postquee-connector'); ?></a>
		</p>
		<?php
	}

	public function handle_save_post($post_id)
	{
		// Checks
		if (!isset($_POST['postquee_meta_nonce']) || !wp_verify_nonce($_POST['postquee_meta_nonce'], 'postquee_save_action')) {
			return;
		}
		if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE)
			return;
		if (!current_user_can('edit_post', $post_id))
			return;

		// Check if "Schedule" is checked
		if (!isset($_POST['postquee_schedule'])) {
			return;
		}

		$post = get_post($post_id);
		$title = $post->post_title;
		$permalink = get_permalink($post_id);
		$selected_channels = isset($_POST['postquee_channels']) ? $_POST['postquee_channels'] : array();

		// Construct Payload
		$content = $title . "\n\n" . $permalink;

		// POST /posts endpoint per instructions
		$body = array(
			'content' => $content,
			'providers' => $selected_channels, // Assuming API expects 'providers' or 'channels' array of IDs. Adjusting based on standard Postiz structure. 
			// If Postiz API expects 'posts' array structure, we map it:
			// "posts": [ { "content": ..., "channels": [...] } ] ?
			// The instructions just said "trigger a POST /posts... with title, link, selected channels".
			// I will try a standard flat payload or the one seen in typical Postiz docs.
			// Reverting to documented Postiz structure: { type: 'draft', posts: [ { content:..., integration: {id: ...} } ] } works best if creating multiple.
			// But for a single post distribution, typically:
			'title' => $title, // Some APIs take title separate
		);
		// Let's refine payload based on "Create a new social post"
		// If it's a unified creation:
		$payload = array(
			'type' => 'draft', // Safe default
			'posts' => array()
		);

		// If channels selected, create a post entry for each or one unified?
		// Postiz usually handles one 'post' object per channel OR one master.
		// Detailed prompt didn't specify JSON structure, only fields.
		// I will create one entry per channel to be safe, or just one global if supported.
		// Let's assume one global content.

		if (empty($selected_channels)) {
			// If no channels, just draft it generally?
			$payload['posts'][] = array('content' => $content);
		} else {
			foreach ($selected_channels as $ch_id) {
				$payload['posts'][] = array(
					'content' => $content,
					'integration' => array('id' => $ch_id)
				);
			}
		}

		// Fire request
		$this->request('/posts', 'POST', $payload);
	}

	// --------------------------------------------------------------------------
	// Utilities / AJAX
	// --------------------------------------------------------------------------
	private function get_channels_cached()
	{
		$cached = get_transient('postquee_channels');
		if ($cached !== false) {
			return $cached;
		}

		$response = $this->request('/social/channels'); // GET /social/channels

		if (is_wp_error($response)) {
			return $response; // Return error to caller
		}

		// Ensure array
		$channels = isset($response['data']) ? $response['data'] : $response;

		if (is_array($channels)) {
			set_transient('postquee_channels', $channels, 1 * HOUR_IN_SECONDS);
		}

		return $channels;
	}

	public function ajax_delete_post()
	{
		check_ajax_referer('postquee_nonce', 'nonce');
		if (!current_user_can('manage_options'))
			wp_send_json_error('Permission denied');

		$id = isset($_POST['id']) ? sanitize_text_field($_POST['id']) : '';
		if (!$id)
			wp_send_json_error('Missing ID');

		$res = $this->request('/posts/' . $id, 'DELETE');

		if (is_wp_error($res)) {
			wp_send_json_error($res->get_error_message());
		}

		wp_send_json_success('Deleted');
	}

	// Manual Trigger from Admin Bar
	public function ajax_send_post_manual()
	{
		check_ajax_referer('postquee_nonce', 'nonce');
		if (!current_user_can('edit_posts'))
			wp_send_json_error('Denied');

		$title = isset($_POST['title']) ? sanitize_text_field(wp_unslash($_POST['title'])) : '';
		$url = isset($_POST['url']) ? esc_url_raw(wp_unslash($_POST['url'])) : '';

		$content = $title . "\n\n" . $url;
		$body = array(
			'type' => 'draft',
			'posts' => array(
				array('content' => $content)
			)
		);

		$res = $this->request('/posts', 'POST', $body);

		if (is_wp_error($res)) {
			wp_send_json_error($res->get_error_message());
		}

		wp_send_json_success(array('message' => 'Sent to Drafts'));
	}

	// Admin Bar Logic (Keeping this as requested)
	public function add_admin_bar_menu($wp_admin_bar)
	{
		if (!current_user_can('edit_posts') || !is_singular() || !isset($GLOBALS['post']))
			return;

		$post = $GLOBALS['post'];
		$title = get_the_title($post->ID);
		$permalink = get_permalink($post->ID);
		$excerpt = get_the_excerpt($post->ID);
		$featured_image = get_the_post_thumbnail_url($post->ID, 'full');

		$button_html = sprintf(
			'<span class="ab-icon dashicons-share-alt2"></span><span class="ab-label send-to-postquee-api" style="cursor:pointer;" data-title="%s" data-url="%s" data-image="%s" data-excerpt="%s">%s</span>',
			esc_attr($title),
			esc_attr($permalink),
			esc_attr($featured_image),
			esc_attr($excerpt),
			esc_html__('PostQuee', 'postquee-connector')
		);

		$wp_admin_bar->add_node(array(
			'id' => 'postquee-admin-bar',
			'title' => $button_html,
			'href' => '#',
			'meta' => array('class' => 'postquee-admin-bar-item', 'onclick' => 'return false;')
		));
	}

	public function add_privacy_policy_content()
	{
		if (function_exists('wp_add_privacy_policy_content')) {
			wp_add_privacy_policy_content(
				'PostQuee Connector',
				wp_kses_post('<p>' . __('This plugin sends post data to PostQuee/Postiz via API.', 'postquee-connector') . '</p>')
			);
		}
	}
}
